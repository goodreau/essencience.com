version: '3.8'

services:
  # Qdrant Vector Database for RAG
  qdrant:
    image: qdrant/qdrant:latest
    container_name: essencience-qdrant
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - rag-network

  # Ollama for local LLM embeddings
  ollama:
    image: ollama/ollama:latest
    container_name: essencience-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - rag-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: essencience-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - rag-network

  # PostgreSQL with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    container_name: essencience-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: essencience_rag
      POSTGRES_USER: essencience
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - rag-network

  # Meilisearch for full-text search
  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: essencience-meilisearch
    ports:
      - "7700:7700"
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-masterKey}
      MEILI_ENV: development
    volumes:
      - meilisearch_data:/meili_data
    restart: unless-stopped
    networks:
      - rag-network

volumes:
  qdrant_storage:
    driver: local
  ollama_data:
    driver: local
  redis_data:
    driver: local
  postgres_data:
    driver: local
  meilisearch_data:
    driver: local

networks:
  rag-network:
    driver: bridge
